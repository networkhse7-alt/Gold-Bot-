"""
ğŸš€ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø¥ØµØ¯Ø§Ø± Ù…ØªÙ…ÙŠØ²
âœ… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø© ÙÙ‚Ø·
âœ… Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙ‚Ø· (Ù„Ø§ Ù…Ø­Ø§ÙƒØ§Ø©)
âœ… Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©: RSI + EMA + MACD
âœ… ÙˆØ§Ø¬Ù‡Ø© ÙˆÙŠØ¨ Ù…ØªØ·ÙˆØ±Ø©
âœ… ÙŠØ¹Ù…Ù„ 100% Ø¹Ù„Ù‰ Replit
"""

import os
import sys
import subprocess
import time
from datetime import datetime, timedelta
import warnings
import random
warnings.filterwarnings('ignore')

print("=" * 60)
print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù…Ø¹ Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©...")
print("=" * 60)

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
REQUIRED_PACKAGES = ['flask', 'requests', 'yfinance', 'pandas', 'numpy', 'ta']

for package in REQUIRED_PACKAGES:
    try:
        __import__(package.replace('-', '_'))
        print(f"âœ… {package} Ù…Ø«Ø¨Øª")
    except ImportError:
        print(f"ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ«Ø¨ÙŠØª {package}...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", package, "--quiet"])

print("\nğŸ“ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª...")

import pandas as pd
import numpy as np
import requests
import ta  # Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©
from flask import Flask, jsonify, render_template_string
from threading import Thread, Lock

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ yfinance
try:
    import yfinance as yf
    YF_WORKING = True
    print("âœ… yfinance Ù…Ø«Ø¨Øª")
except:
    YF_WORKING = False
    print("âš ï¸ yfinance ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø©")

print("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¬Ø§Ù‡Ø²Ø©!")

# ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram ==================
TELEGRAM_TOKEN = "8182359938:AAGX1i_MkGtRnfaCgvEeswSzD13Ydde-nLA"
TELEGRAM_CHAT_ID = "926218869"
TELEGRAM_ENABLED = True

# ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØª ==================
HOURLY_REPORT_INTERVAL = 3600  # ÙƒÙ„ Ø³Ø§Ø¹Ø© (3600 Ø«Ø§Ù†ÙŠØ©)
MIN_SIGNAL_STRENGTH = 70      # Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (Ù…Ù† 100)
PRICE_UPDATE_INTERVAL = 300   # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

# ================== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==================

app = Flask(__name__)

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª
current_prices = {
    'gold': {'price': 0, 'rsi': 50, 'ema_short': 0, 'ema_long': 0, 'macd': 0, 'macd_signal': 0, 
             'trend': 'Ù…Ø­Ø§ÙŠØ¯', 'signal_strength': 0, 'indicators': {}},
    'btc': {'price': 0, 'rsi': 50, 'ema_short': 0, 'ema_long': 0, 'macd': 0, 'macd_signal': 0,
            'trend': 'Ù…Ø­Ø§ÙŠØ¯', 'signal_strength': 0, 'indicators': {}},
    'silver': {'price': 0, 'rsi': 50, 'ema_short': 0, 'ema_long': 0, 'macd': 0, 'macd_signal': 0,
               'trend': 'Ù…Ø­Ø§ÙŠØ¯', 'signal_strength': 0, 'indicators': {}}
}

trading_signals = []
last_hourly_report = None
last_price_update = None
signal_lock = Lock()

class AdvancedTradingBot:
    def __init__(self):
        self.running = True
        self.price_history = {
            'gold': [],
            'btc': [],
            'silver': []
        }
        self.full_price_data = {
            'gold': pd.DataFrame(),
            'btc': pd.DataFrame(),
            'silver': pd.DataFrame()
        }
        self.history_length = 100
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
        self.ema_short_period = 12
        self.ema_long_period = 26
        self.macd_fast = 12
        self.macd_slow = 26
        self.macd_signal_period = 9
        self.rsi_period = 14

        # ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
        self.sent_signals_today = set()
        self.last_signal_time = {}

    def send_telegram(self, message):
        """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Telegram"""
        if not TELEGRAM_ENABLED:
            return False

        try:
            url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
            data = {
                'chat_id': TELEGRAM_CHAT_ID,
                'text': message,
                'parse_mode': 'HTML'
            }
            response = requests.post(url, json=data, timeout=10)
            return response.status_code == 200
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Telegram: {e}")
            return False

    def should_send_hourly_report(self):
        """ÙØ­Øµ Ø¥Ø°Ø§ Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø§Ø¹ÙŠ"""
        global last_hourly_report

        now = datetime.now()
        if last_hourly_report is None:
            last_hourly_report = now
            return True

        time_diff = (now - last_hourly_report).total_seconds()
        return time_diff >= HOURLY_REPORT_INTERVAL

    def send_hourly_report(self):
        """Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ø³Ø§Ø¹Ø©"""
        global last_hourly_report

        try:
            report_time = datetime.now().strftime("%H:%M:%S")
            report_date = datetime.now().strftime("%Y-%m-%d")

            # ØªØ­Ø¶ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            indicators_report = ""
            for asset, data in current_prices.items():
                if data['price'] > 0:
                    name = {'gold': 'Ø§Ù„Ø°Ù‡Ø¨', 'btc': 'Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†', 'silver': 'Ø§Ù„ÙØ¶Ø©'}[asset]
                    ema_status = "ğŸŸ¢" if data['ema_short'] > data['ema_long'] else "ğŸ”´"
                    macd_status = "ğŸŸ¢" if data['macd'] > data['macd_signal'] else "ğŸ”´"
                    rsi_status = "ğŸŸ¢" if data['rsi'] < 40 else "ğŸ”´" if data['rsi'] > 60 else "âšª"
                    
                    indicators_report += f"""
â€¢ {name}:
  EMA: {ema_status} | MACD: {macd_status} | RSI: {rsi_status} ({data['rsi']})
                    """

            report_msg = f"""â° <b>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… - ÙƒÙ„ Ø³Ø§Ø¹Ø©</b>

ğŸ“Š <b>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:</b> âœ… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­
â° <b>Ø§Ù„ÙˆÙ‚Øª:</b> {report_time}
ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> {report_date}

ğŸ“ˆ <b>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø£Ø³Ø¹Ø§Ø±:</b>
â€¢ Ø§Ù„Ø°Ù‡Ø¨: ${current_prices['gold']['price']:,.2f}
â€¢ Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†: ${current_prices['btc']['price']:,.2f}
â€¢ Ø§Ù„ÙØ¶Ø©: ${current_prices['silver']['price']:,.2f}

ğŸ“Š <b>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:</b>
{indicators_report}

ğŸ¯ <b>Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©:</b> {len(trading_signals)} Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…

ğŸ¤– <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b>
Ø§Ù„Ø¨ÙˆØª ÙŠØ±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø¨Ù€ 3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ©:
RSI + EMA + MACD

#ØªÙ‚Ø±ÙŠØ±_Ø³Ø§Ø¹ÙŠ #Ù…Ø±Ø§Ù‚Ø¨Ø©_Ø§Ù„Ø£Ø³ÙˆØ§Ù‚"""

            if self.send_telegram(report_msg):
                print(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ ({report_time})")
                last_hourly_report = datetime.now()
                return True
            else:
                print("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ")
                return False

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ: {e}")
            return False

    def get_real_price(self, symbol_type, asset):
        """Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª"""
        try:
            if not YF_WORKING:
                return None, "yfinance ØºÙŠØ± Ù…ØªÙˆÙØ±", None

            ticker_map = {
                'gold': ['GC=F', 'XAUUSD=X'],
                'btc': ['BTC-USD', 'BTC-USD'],
                'silver': ['SI=F', 'XAGUSD=X']
            }

            symbols = ticker_map.get(asset, [])
            for symbol in symbols:
                try:
                    ticker = yf.Ticker(symbol)
                    
                    # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ø£ÙƒØ«Ø± Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                    hist = ticker.history(period='1mo', interval='1h')
                    
                    if not hist.empty and len(hist) > 50:
                        price = float(hist['Close'].iloc[-1])
                        
                        # ØªØ­ÙˆÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ETF
                        if symbol in ['GLD']:
                            price = price * 10
                        elif symbol in ['SLV']:
                            price = price * 50
                        
                        return price, f"Yahoo Finance ({symbol})", hist
                        
                except Exception as e:
                    continue

            return None, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª", None

        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¹Ø± {asset}: {e}")
            return None, f"Ø®Ø·Ø£: {str(e)[:50]}", None

    def calculate_technical_indicators(self, price_data, current_price):
        """Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©"""
        if price_data is None or len(price_data) < 50:
            return {
                'rsi': 50,
                'ema_short': current_price,
                'ema_long': current_price,
                'macd': 0,
                'macd_signal': 0,
                'macd_histogram': 0,
                'trend_ema': 'Ù…Ø­Ø§ÙŠØ¯',
                'trend_macd': 'Ù…Ø­Ø§ÙŠØ¯',
                'trend_rsi': 'Ù…Ø­Ø§ÙŠØ¯'
            }

        try:
            df = price_data.copy()
            
            # Ø­Ø³Ø§Ø¨ RSI
            rsi_indicator = ta.momentum.RSIIndicator(
                close=df['Close'], 
                window=self.rsi_period
            )
            rsi = rsi_indicator.rsi().iloc[-1]
            
            # Ø­Ø³Ø§Ø¨ EMA
            ema_short = ta.trend.EMAIndicator(
                close=df['Close'], 
                window=self.ema_short_period
            ).ema_indicator().iloc[-1]
            
            ema_long = ta.trend.EMAIndicator(
                close=df['Close'], 
                window=self.ema_long_period
            ).ema_indicator().iloc[-1]
            
            # Ø­Ø³Ø§Ø¨ MACD
            macd_indicator = ta.trend.MACD(
                close=df['Close'],
                window_slow=self.macd_slow,
                window_fast=self.macd_fast,
                window_sign=self.macd_signal_period
            )
            macd = macd_indicator.macd().iloc[-1]
            macd_signal = macd_indicator.macd_signal().iloc[-1]
            macd_histogram = macd_indicator.macd_diff().iloc[-1]
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
            trend_ema = "ØµØ§Ø¹Ø¯" if ema_short > ema_long else "Ù‡Ø§Ø¨Ø·" if ema_short < ema_long else "Ù…Ø­Ø§ÙŠØ¯"
            trend_macd = "ØµØ§Ø¹Ø¯" if macd > macd_signal else "Ù‡Ø§Ø¨Ø·" if macd < macd_signal else "Ù…Ø­Ø§ÙŠØ¯"
            
            if rsi < 30:
                trend_rsi = "Ù…Ø´ØªØ±Ù‰ Ù‚ÙˆÙŠ"
            elif rsi < 40:
                trend_rsi = "Ù…Ø´ØªØ±Ù‰"
            elif rsi > 70:
                trend_rsi = "Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ"
            elif rsi > 60:
                trend_rsi = "Ø¨ÙŠØ¹"
            else:
                trend_rsi = "Ù…Ø­Ø§ÙŠØ¯"

            return {
                'rsi': round(rsi, 2),
                'ema_short': round(ema_short, 2) if not pd.isna(ema_short) else current_price,
                'ema_long': round(ema_long, 2) if not pd.isna(ema_long) else current_price,
                'macd': round(macd, 4) if not pd.isna(macd) else 0,
                'macd_signal': round(macd_signal, 4) if not pd.isna(macd_signal) else 0,
                'macd_histogram': round(macd_histogram, 4) if not pd.isna(macd_histogram) else 0,
                'trend_ema': trend_ema,
                'trend_macd': trend_macd,
                'trend_rsi': trend_rsi
            }

        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª: {e}")
            return {
                'rsi': 50,
                'ema_short': current_price,
                'ema_long': current_price,
                'macd': 0,
                'macd_signal': 0,
                'macd_histogram': 0,
                'trend_ema': 'Ù…Ø­Ø§ÙŠØ¯',
                'trend_macd': 'Ù…Ø­Ø§ÙŠØ¯',
                'trend_rsi': 'Ù…Ø­Ø§ÙŠØ¯'
            }

    def calculate_signal_strength(self, indicators, current_price):
        """Ø­Ø³Ø§Ø¨ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©"""
        try:
            strength_components = []
            
            # 1. Ù‚ÙˆØ© RSI (Ø§Ù„ÙˆØ²Ù†: 35%)
            rsi = indicators['rsi']
            if rsi < 30:
                rsi_strength = 95
            elif rsi < 35:
                rsi_strength = 85
            elif rsi < 40:
                rsi_strength = 75
            elif rsi > 70:
                rsi_strength = 95
            elif rsi > 65:
                rsi_strength = 85
            elif rsi > 60:
                rsi_strength = 75
            else:
                rsi_strength = 50
            strength_components.append(('RSI', rsi_strength, 0.35))
            
            # 2. Ù‚ÙˆØ© EMA (Ø§Ù„ÙˆØ²Ù†: 35%)
            ema_diff = ((indicators['ema_short'] - indicators['ema_long']) / indicators['ema_long']) * 100
            if indicators['ema_short'] > indicators['ema_long']:
                if ema_diff > 2:
                    ema_strength = 90
                elif ema_diff > 1:
                    ema_strength = 80
                elif ema_diff > 0.5:
                    ema_strength = 70
                else:
                    ema_strength = 60
            else:
                if ema_diff < -2:
                    ema_strength = 90
                elif ema_diff < -1:
                    ema_strength = 80
                elif ema_diff < -0.5:
                    ema_strength = 70
                else:
                    ema_strength = 60
            strength_components.append(('EMA', ema_strength, 0.35))
            
            # 3. Ù‚ÙˆØ© MACD (Ø§Ù„ÙˆØ²Ù†: 30%)
            macd_hist = indicators['macd_histogram']
            if macd_hist > 0:
                if macd_hist > 0.01:
                    macd_strength = 90
                elif macd_hist > 0.005:
                    macd_strength = 80
                elif macd_hist > 0.001:
                    macd_strength = 70
                else:
                    macd_strength = 60
            else:
                if macd_hist < -0.01:
                    macd_strength = 90
                elif macd_hist < -0.005:
                    macd_strength = 80
                elif macd_hist < -0.001:
                    macd_strength = 70
                else:
                    macd_strength = 60
            strength_components.append(('MACD', macd_strength, 0.30))
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø©
            total_strength = 0
            for name, strength, weight in strength_components:
                total_strength += strength * weight
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù…
            buy_signals = 0
            sell_signals = 0
            
            if rsi < 40:
                buy_signals += 1
            elif rsi > 60:
                sell_signals += 1
                
            if indicators['ema_short'] > indicators['ema_long']:
                buy_signals += 1
            else:
                sell_signals += 1
                
            if indicators['macd'] > indicators['macd_signal']:
                buy_signals += 1
            else:
                sell_signals += 1
            
            if buy_signals >= 2:
                trend = "ØµØ§Ø¹Ø¯"
                signal_type = "Ø´Ø±Ø§Ø¡"
                # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                if buy_signals == 3:
                    total_strength = min(total_strength * 1.15, 100)
            elif sell_signals >= 2:
                trend = "Ù‡Ø§Ø¨Ø·"
                signal_type = "Ø¨ÙŠØ¹"
                if sell_signals == 3:
                    total_strength = min(total_strength * 1.15, 100)
            else:
                trend = "Ù…Ø­Ø§ÙŠØ¯"
                signal_type = "Ø§Ù†ØªØ¸Ø§Ø±"
                total_strength = max(total_strength * 0.7, 30)
            
            return {
                'total_strength': round(total_strength, 1),
                'trend': trend,
                'signal_type': signal_type,
                'components': strength_components,
                'buy_signals': buy_signals,
                'sell_signals': sell_signals
            }
            
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {e}")
            return {
                'total_strength': 50,
                'trend': 'Ù…Ø­Ø§ÙŠØ¯',
                'signal_type': 'Ø§Ù†ØªØ¸Ø§Ø±',
                'components': [],
                'buy_signals': 0,
                'sell_signals': 0
            }

    def analyze_asset_with_indicators(self, asset_key, asset_name):
        """ØªØ­Ù„ÙŠÙ„ Ø£ØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©"""
        try:
            # Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
            price, source, historical_data = self.get_real_price(
                'forex' if asset_key in ['gold', 'silver'] else 'crypto', 
                asset_key
            )

            if price is None or historical_data is None:
                return None

            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            self.full_price_data[asset_key] = historical_data
            
            # Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            indicators = self.calculate_technical_indicators(historical_data, price)
            
            # Ø­Ø³Ø§Ø¨ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            signal_info = self.calculate_signal_strength(indicators, price)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            current_prices[asset_key] = {
                'price': price,
                'rsi': indicators['rsi'],
                'ema_short': indicators['ema_short'],
                'ema_long': indicators['ema_long'],
                'macd': indicators['macd'],
                'macd_signal': indicators['macd_signal'],
                'macd_histogram': indicators['macd_histogram'],
                'trend': signal_info['trend'],
                'signal_strength': signal_info['total_strength'],
                'indicators': {
                    'rsi_trend': indicators['trend_rsi'],
                    'ema_trend': indicators['trend_ema'],
                    'macd_trend': indicators['trend_macd'],
                    'signal_type': signal_info['signal_type'],
                    'buy_signals': signal_info['buy_signals'],
                    'sell_signals': signal_info['sell_signals'],
                    'strength_components': signal_info['components']
                }
            }

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
            if signal_info['total_strength'] < MIN_SIGNAL_STRENGTH:
                return None

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            signal_key = f"{asset_key}_{indicators['rsi']}_{indicators['ema_short']}_{indicators['macd']}"
            today = datetime.now().strftime("%Y-%m-%d")
            daily_key = f"{signal_key}_{today}"

            if daily_key in self.sent_signals_today:
                return None

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø§Ø±Ø© Ù…ÙØµÙ„Ø©
            signal_type = signal_info['signal_type']
            if signal_type == "Ø´Ø±Ø§Ø¡":
                if signal_info['buy_signals'] == 3:
                    action = 'Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ ğŸŸ¢ğŸŸ¢'
                    reason = f'âœ… ØªÙˆØ§ÙÙ‚ ÙƒØ§Ù…Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©\nğŸ“Š RSI: {indicators["rsi"]} (Ù…Ø´ØªØ±Ù‰)\nğŸ“ˆ EMA: {indicators["trend_ema"]}\nğŸ¯ MACD: {indicators["trend_macd"]}'
                else:
                    action = 'Ø´Ø±Ø§Ø¡ ğŸŸ¢'
                    reason = f'âœ… {signal_info["buy_signals"]}/3 Ù…Ø¤Ø´Ø±Ø§Øª ØªØ´ÙŠØ± Ù„Ù„Ø´Ø±Ø§Ø¡\nğŸ“Š RSI: {indicators["rsi"]}\nğŸ“ˆ EMA: {indicators["trend_ema"]}\nğŸ¯ MACD: {indicators["trend_macd"]}'
                    
            elif signal_type == "Ø¨ÙŠØ¹":
                if signal_info['sell_signals'] == 3:
                    action = 'Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ ğŸ”´ğŸ”´'
                    reason = f'âŒ ØªÙˆØ§ÙÙ‚ ÙƒØ§Ù…Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©\nğŸ“Š RSI: {indicators["rsi"]} (Ø¨ÙŠØ¹)\nğŸ“ˆ EMA: {indicators["trend_ema"]}\nğŸ¯ MACD: {indicators["trend_macd"]}'
                else:
                    action = 'Ø¨ÙŠØ¹ ğŸ”´'
                    reason = f'âŒ {signal_info["sell_signals"]}/3 Ù…Ø¤Ø´Ø±Ø§Øª ØªØ´ÙŠØ± Ù„Ù„Ø¨ÙŠØ¹\nğŸ“Š RSI: {indicators["rsi"]}\nğŸ“ˆ EMA: {indicators["trend_ema"]}\nğŸ¯ MACD: {indicators["trend_macd"]}'
            else:
                return None

            signal = {
                'asset': asset_key,
                'name': asset_name,
                'price': price,
                'action': action,
                'strength_score': signal_info['total_strength'],
                'reason': reason,
                'rsi': indicators['rsi'],
                'ema_short': indicators['ema_short'],
                'ema_long': indicators['ema_long'],
                'macd': indicators['macd'],
                'macd_signal': indicators['macd_signal'],
                'macd_histogram': indicators['macd_histogram'],
                'trend_rsi': indicators['trend_rsi'],
                'trend_ema': indicators['trend_ema'],
                'trend_macd': indicators['trend_macd'],
                'buy_signals': signal_info['buy_signals'],
                'sell_signals': signal_info['sell_signals'],
                'time': datetime.now().strftime("%H:%M:%S"),
                'date': today,
                'source': source
            }

            # Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØªØ¨Ø¹
            self.sent_signals_today.add(daily_key)
            if len(self.sent_signals_today) > 50:
                self.sent_signals_today = set(list(self.sent_signals_today)[-30:])

            return signal

        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ {asset_name}: {e}")
            return None

    def send_advanced_signal_to_telegram(self, signal):
        """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ø¥Ù„Ù‰ Telegram"""
        try:
            emoji = "ğŸŸ¢ğŸŸ¢" if "Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹" in signal['action'] else "ğŸŸ¢" if "Ø´Ø±Ø§Ø¡" in signal['action'] else "ğŸ”´ğŸ”´" if "Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹" in signal['action'] else "ğŸ”´"
            
            # ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            indicators_details = f"""
ğŸ“Š <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:</b>
â€¢ RSI: {signal['rsi']} ({signal['trend_rsi']})
â€¢ EMA: {signal['trend_ema']} ({signal['ema_short']:.2f}/{signal['ema_long']:.2f})
â€¢ MACD: {signal['trend_macd']} ({signal['macd']:.4f}/{signal['macd_signal']:.4f})

ğŸ¯ <b>ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:</b>
â€¢ {signal['buy_signals']}/3 Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ø´Ø±Ø§Ø¡
â€¢ {signal['sell_signals']}/3 Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ø¨ÙŠØ¹"""

            message = f"""
{emoji} <b>ğŸ¯ Ø¥Ø´Ø§Ø±Ø© ØªØ¯Ø§ÙˆÙ„ Ù…ØªÙ‚Ø¯Ù…Ø©!</b> {emoji}

ğŸ¦ <b>Ø§Ù„Ø£ØµÙ„:</b> {signal['name']}
ğŸ¯ <b>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</b> {signal['action']}
ğŸ’ª <b>Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:</b> {signal['strength_score']}/100

ğŸ’° <b>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${signal['price']:,.2f}
{indicators_details}

ğŸ“ <b>Ø§Ù„ØªØ­Ù„ÙŠÙ„:</b>
{signal['reason']}

ğŸ” <b>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</b> {signal['source']}
â° <b>Ø§Ù„ÙˆÙ‚Øª:</b> {signal['time']}
ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> {signal['date']}

âš ï¸ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b>
Ù‡Ø°Ù‡ Ø¥Ø´Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ 3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ©
RSI + EMA + MACD

#{signal['asset']} #ØªØ¯Ø§ÙˆÙ„_Ù…ØªÙ‚Ø¯Ù… #Ø¥Ø´Ø§Ø±Ø©_Ø­Ù‚ÙŠÙ‚ÙŠØ©
            """

            if self.send_telegram(message):
                print(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©: {signal['name']} - {signal['action']}")
                return True
            else:
                print(f"âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø©: {signal['name']}")
                return False

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {e}")
            return False

    def update_all_prices_with_indicators(self):
        """ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª"""
        try:
            assets = [
                ('gold', 'Ø§Ù„Ø°Ù‡Ø¨'),
                ('btc', 'Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†'),
                ('silver', 'Ø§Ù„ÙØ¶Ø©')
            ]
            
            for asset_key, asset_name in assets:
                price, source, historical_data = self.get_real_price(
                    'forex' if asset_key in ['gold', 'silver'] else 'crypto',
                    asset_key
                )
                
                if price and historical_data is not None:
                    self.full_price_data[asset_key] = historical_data
                    
                    indicators = self.calculate_technical_indicators(historical_data, price)
                    signal_info = self.calculate_signal_strength(indicators, price)
                    
                    current_prices[asset_key] = {
                        'price': price,
                        'rsi': indicators['rsi'],
                        'ema_short': indicators['ema_short'],
                        'ema_long': indicators['ema_long'],
                        'macd': indicators['macd'],
                        'macd_signal': indicators['macd_signal'],
                        'macd_histogram': indicators['macd_histogram'],
                        'trend': signal_info['trend'],
                        'signal_strength': signal_info['total_strength'],
                        'indicators': {
                            'rsi_trend': indicators['trend_rsi'],
                            'ema_trend': indicators['trend_ema'],
                            'macd_trend': indicators['trend_macd'],
                            'signal_type': signal_info['signal_type'],
                            'buy_signals': signal_info['buy_signals'],
                            'sell_signals': signal_info['sell_signals']
                        }
                    }

            return True

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: {e}")
            return False

    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
        print("\nğŸ¤– Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…")
        print("ğŸ“Š Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:")
        print("   â€¢ ğŸ“ˆ 3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ©: RSI + EMA + MACD")
        print("   â€¢ â° ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ ÙÙ‚Ø·")
        print("   â€¢ ğŸ¯ Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙÙ‚Ø· (Ù‚ÙˆØ© > 70/100)")
        print("   â€¢ ğŸ¤– Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Telegram Ù…ØªÙ‚Ø¯Ù…Ø©")
        print("=" * 60)

        if TELEGRAM_ENABLED:
            start_msg = f"""ğŸš€ <b>Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†!</b>

ğŸ“Š <b>Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</b>
â€¢ 3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©
â€¢ ØªØ­Ù„ÙŠÙ„ RSI Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ´Ø¨Ø¹
â€¢ ØªØ­Ù„ÙŠÙ„ EMA Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
â€¢ ØªØ­Ù„ÙŠÙ„ MACD Ù„Ù„Ø²Ø®Ù…

ğŸ¯ <b>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„:</b>
1. ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ Ø³Ø§Ø¹Ø© Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
2. Ø¥Ø´Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª

âš™ï¸ <b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:</b>
â€¢ RSI: 14 ÙØªØ±Ø©
â€¢ EMA: 12 Ùˆ 26 ÙØªØ±Ø©
â€¢ MACD: 12, 26, 9

â° {datetime.now().strftime("%H:%M:%S")}
ğŸ“… {datetime.now().strftime("%Y-%m-%d")}

#Ø¨Ø¯Ø¡_Ø§Ù„ØªØ´ØºÙŠÙ„ #Ø¨ÙˆØª_Ù…ØªÙ‚Ø¯Ù…"""

            self.send_telegram(start_msg)

        cycle = 0
        price_update_counter = 0

        while self.running:
            try:
                cycle += 1
                print(f"\nğŸ”„ Ø§Ù„Ø¯ÙˆØ±Ø© #{cycle}")
                print(f"â° {datetime.now().strftime('%H:%M:%S')}")

                # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ
                if self.should_send_hourly_report():
                    self.send_hourly_report()

                # 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                price_update_counter += 1
                if price_update_counter >= (PRICE_UPDATE_INTERVAL / 30):
                    print("ğŸ“ˆ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª...")
                    self.update_all_prices_with_indicators()
                    price_update_counter = 0

                # 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø´Ø§Ø±Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                real_signals = []

                for asset_key, asset_name in [('gold', 'Ø§Ù„Ø°Ù‡Ø¨'), ('btc', 'Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†'), ('silver', 'Ø§Ù„ÙØ¶Ø©')]:
                    signal = self.analyze_asset_with_indicators(asset_key, asset_name)
                    if signal:
                        real_signals.append(signal)

                # 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù‚ÙˆÙŠØ©
                if real_signals:
                    print(f"ğŸ¯ ØªÙ… Ø§ÙƒØªØ´Ø§Ù {len(real_signals)} Ø¥Ø´Ø§Ø±Ø© Ù‚ÙˆÙŠØ©")

                    for signal in real_signals:
                        with signal_lock:
                            trading_signals.append(signal)
                            if len(trading_signals) > 20:
                                trading_signals.pop(0)

                        if TELEGRAM_ENABLED:
                            self.send_advanced_signal_to_telegram(signal)

                        print(f"   ğŸ“¢ {signal['name']}: {signal['action']} (Ù‚ÙˆØ©: {signal['strength_score']}/100)")
                        print(f"     ğŸ“Š RSI: {signal['rsi']} | ğŸ“ˆ EMA: {signal['trend_ema']} | ğŸ¯ MACD: {signal['trend_macd']}")
                else:
                    print("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª Ù‚ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹")

                # 5. Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                print(f"\nğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:")
                for asset, data in current_prices.items():
                    name = {'gold': 'Ø§Ù„Ø°Ù‡Ø¨', 'btc': 'Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†', 'silver': 'Ø§Ù„ÙØ¶Ø©'}[asset]
                    if data['price'] > 0:
                        strength_indicator = "ğŸ”´" if data['signal_strength'] >= 70 else "ğŸŸ¡" if data['signal_strength'] >= 50 else "ğŸŸ¢"
                        indicators_status = f"RSI:{data['rsi']} EMA:{data['indicators']['ema_trend']} MACD:{data['indicators']['macd_trend']}"
                        print(f"   â€¢ {name}: ${data['price']:,.2f} | Ù‚ÙˆØ©: {data['signal_strength']}/100 {strength_indicator}")
                        print(f"     ğŸ“Š {indicators_status}")

                print(f"\nâ³ Ø§Ù†ØªØ¸Ø§Ø± 30 Ø«Ø§Ù†ÙŠØ©...")
                time.sleep(30)

            except KeyboardInterrupt:
                print("\nğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª...")
                self.running = False
                break
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
                time.sleep(30)

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
bot = AdvancedTradingBot()

# ================== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ==================

@app.route('/')
def advanced_dashboard():
    """Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"""
    html = '''
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                color: #e2e8f0;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1600px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                padding: 40px 20px;
                background: linear-gradient(90deg, #7c3aed 0%, #4f46e5 100%);
                border-radius: 20px;
                margin-bottom: 40px;
                box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
                position: relative;
                overflow: hidden;
            }

            .header::before {
                content: "ğŸ“Š";
                position: absolute;
                font-size: 150px;
                opacity: 0.1;
                right: -30px;
                top: -30px;
            }

            .header h1 {
                font-size: 2.8rem;
                margin-bottom: 10px;
                background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }

            .badges-container {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 20px;
            }

            .badge {
                display: inline-block;
                padding: 8px 20px;
                border-radius: 50px;
                font-weight: bold;
                font-size: 0.9rem;
                border: 2px solid;
            }

            .badge-success { background: #10b981; color: white; border-color: #10b981; }
            .badge-indicator { background: #3b82f6; color: white; border-color: #3b82f6; }
            .badge-warning { background: #f59e0b; color: white; border-color: #f59e0b; }
            .badge-danger { background: #ef4444; color: white; border-color: #ef4444; }

            .indicators-header {
                text-align: center;
                margin: 30px 0;
                padding: 20px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
            }

            .indicator-item {
                display: inline-block;
                margin: 0 15px;
                text-align: center;
            }

            .indicator-icon {
                font-size: 2.5rem;
                margin-bottom: 10px;
            }

            .cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
                gap: 25px;
                margin-bottom: 40px;
            }

            .card {
                background: rgba(30, 41, 59, 0.7);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 25px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.3s;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            }

            .price {
                font-size: 2.5rem;
                font-weight: bold;
                margin: 15px 0;
                color: #fbbf24;
            }

            .indicators-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin: 20px 0;
            }

            .indicator-box {
                background: rgba(255, 255, 255, 0.05);
                padding: 15px;
                border-radius: 10px;
                text-align: center;
            }

            .indicator-value {
                font-size: 1.2rem;
                font-weight: bold;
                margin: 5px 0;
            }

            .signal-card {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
                padding: 20px;
                margin: 15px 0;
                border-left: 5px solid;
                position: relative;
                overflow: hidden;
            }

            .signal-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: currentColor;
                opacity: 0.3;
            }

            .signal-buy { border-color: #10b981; color: #10b981; }
            .signal-sell { border-color: #ef4444; color: #ef4444; }

            .signal-indicators {
                display: flex;
                gap: 10px;
                margin: 10px 0;
                flex-wrap: wrap;
            }

            .signal-indicator {
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.9rem;
                background: rgba(255, 255, 255, 0.1);
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                background: rgba(255,255,255,0.05);
                padding: 25px;
                border-radius: 15px;
                margin: 30px 0;
            }

            .stat-item {
                text-align: center;
                padding: 15px;
                background: rgba(255,255,255,0.03);
                border-radius: 10px;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: bold;
                color: #60a5fa;
                margin: 10px 0;
            }

            .controls {
                text-align: center;
                margin: 30px 0;
            }

            .btn {
                padding: 12px 30px;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                font-weight: bold;
                font-size: 1.1rem;
                margin: 10px;
                transition: all 0.3s;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .btn-telegram { 
                background: #0088cc; 
                color: white;
            }

            .btn-telegram:hover {
                background: #006699;
                transform: scale(1.05);
            }

            .btn-indicator {
                background: #7c3aed;
                color: white;
            }

            .btn-indicator:hover {
                background: #6d28d9;
                transform: scale(1.05);
            }

            .strength-meter {
                height: 12px;
                background: rgba(255,255,255,0.1);
                border-radius: 6px;
                margin: 15px 0;
                overflow: hidden;
                position: relative;
            }

            .strength-fill {
                height: 100%;
                border-radius: 6px;
                transition: width 0.5s;
                position: relative;
                overflow: hidden;
            }

            .strength-fill::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg, 
                    transparent 0%, 
                    rgba(255,255,255,0.2) 50%, 
                    transparent 100%);
                animation: shine 2s infinite;
            }

            @keyframes shine {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }

            .strength-low { background: linear-gradient(90deg, #10b981, #34d399); }
            .strength-medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
            .strength-high { background: linear-gradient(90deg, #ef4444, #f87171); }

            .time-badge {
                position: absolute;
                top: 15px;
                left: 15px;
                padding: 5px 15px;
                border-radius: 20px;
                background: rgba(0,0,0,0.3);
                font-size: 0.9rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ¤– Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
                <p>3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ©: RSI + EMA + MACD</p>
                <div class="badges-container">
                    <div class="badge badge-success">âœ… ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                    <div class="badge badge-indicator">ğŸ“Š 3 Ù…Ø¤Ø´Ø±Ø§Øª</div>
                    <div class="badge badge-warning">â° ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ</div>
                    <div class="badge badge-danger">ğŸ¯ Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©</div>
                </div>
            </div>

            <div class="indicators-header">
                <h2>ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</h2>
                <div style="margin-top: 20px;">
                    <div class="indicator-item">
                        <div class="indicator-icon">ğŸ“Š</div>
                        <div><strong>RSI</strong></div>
                        <small>14 ÙØªØ±Ø©</small>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-icon">ğŸ“ˆ</div>
                        <div><strong>EMA</strong></div>
                        <small>12 Ùˆ 26 ÙØªØ±Ø©</small>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-icon">ğŸ¯</div>
                        <div><strong>MACD</strong></div>
                        <small>12, 26, 9</small>
                    </div>
                </div>
            </div>

            <div class="cards-grid" id="prices-container">
                <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div>ğŸ“Š Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    <div class="stat-value" id="signals-count">0</div>
                    <small>Ù…Ø±Ø´Ø­Ø© Ù„Ù‚ÙˆØ© > 70</small>
                </div>
                <div class="stat-item">
                    <div>ğŸ’ª Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚ÙˆØ©</div>
                    <div class="stat-value" id="strength-avg">0</div>
                    <small>Ù…Ù† 100 Ù†Ù‚Ø·Ø©</small>
                </div>
                <div class="stat-item">
                    <div>â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
                    <div class="stat-value" id="last-update">Ø§Ù„Ø¢Ù†</div>
                    <small>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
                </div>
                <div class="stat-item">
                    <div>ğŸ¤– Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    <div class="stat-value" style="color: #10b981;" id="system-status">âœ…</div>
                    <small>ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­</small>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-telegram" onclick="testTelegram()">
                    <span>ğŸ“±</span> Ø§Ø®ØªØ¨Ø§Ø± Telegram
                </button>
                <button class="btn btn-indicator" onclick="forceHourlyReport()">
                    <span>â°</span> Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ
                </button>
                <button class="btn btn-indicator" onclick="refreshData()">
                    <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #60a5fa; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ¯</span> Ø¢Ø®Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                </h2>
                <div id="signals-container">
                    <p style="text-align: center; opacity: 0.7; padding: 30px;">
                        ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø´Ø§Ø±Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ù‚ÙˆÙŠØ©...
                    </p>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; color: #94a3b8; font-size: 0.9rem; line-height: 1.6;">
                <p>âš¡ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Replit | ğŸ“Š 3 Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ© | ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚</p>
                <p>ğŸ¯ Ø¥Ø´Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª | âš ï¸ Ù„Ø£ØºØ±Ø§Ø¶ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙÙ‚Ø·</p>
                <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.6;">
                    RSI: Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ© | EMA: Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø§Ù„Ø£Ø³ÙŠ | MACD: Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø§Ø±Ø¨ ÙˆØ§Ù„ØªØ¨Ø§Ø¹Ø¯ Ù„Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
                </p>
            </div>
        </div>

        <script>
            function updateDashboard() {
                fetch('/api/dashboard')
                    .then(response => response.json())
                    .then(data => {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                        const pricesContainer = document.getElementById('prices-container');
                        let pricesHTML = '';

                        const assets = [
                            {key: 'gold', name: 'Ø§Ù„Ø°Ù‡Ø¨', symbol: 'XAUUSD', icon: 'ğŸ§­'},
                            {key: 'btc', name: 'Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†', symbol: 'BTCUSD', icon: 'â‚¿'},
                            {key: 'silver', name: 'Ø§Ù„ÙØ¶Ø©', symbol: 'XAGUSD', icon: 'ğŸ¥ˆ'}
                        ];

                        assets.forEach(asset => {
                            const p = data.prices[asset.key];
                            if (p.price === 0) return;

                            const strengthClass = p.signal_strength >= 70 ? 'strength-high' : 
                                                  p.signal_strength >= 50 ? 'strength-medium' : 'strength-low';
                            const strengthPercent = Math.min(p.signal_strength, 100);
                            
                            // Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                            const rsiColor = p.rsi < 40 ? '#10b981' : p.rsi > 60 ? '#ef4444' : '#f59e0b';
                            const emaColor = p.indicators.ema_trend === 'ØµØ§Ø¹Ø¯' ? '#10b981' : p.indicators.ema_trend === 'Ù‡Ø§Ø¨Ø·' ? '#ef4444' : '#f59e0b';
                            const macdColor = p.indicators.macd_trend === 'ØµØ§Ø¹Ø¯' ? '#10b981' : p.indicators.macd_trend === 'Ù‡Ø§Ø¨Ø·' ? '#ef4444' : '#f59e0b';

                            pricesHTML += `
                                <div class="card">
                                    <div class="time-badge">${data.last_update.split(' ')[1]}</div>
                                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <span style="font-size: 2.5em; margin-right: 15px;">${asset.icon}</span>
                                        <div>
                                            <h3 style="margin: 0; font-size: 1.5rem;">${asset.name}</h3>
                                            <small style="opacity: 0.7;">${asset.symbol}</small>
                                        </div>
                                    </div>
                                    <div class="price">$${p.price.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                    
                                    <div style="margin: 20px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>ğŸ’ª Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: ${p.signal_strength}/100</span>
                                            <span>${p.indicators.signal_type === 'Ø´Ø±Ø§Ø¡' ? 'ğŸŸ¢' : p.indicators.signal_type === 'Ø¨ÙŠØ¹' ? 'ğŸ”´' : 'âšª'} ${p.indicators.signal_type}</span>
                                        </div>
                                        <div class="strength-meter">
                                            <div class="strength-fill ${strengthClass}" style="width: ${strengthPercent}%"></div>
                                        </div>
                                        <div style="text-align: center; margin-top: 5px; font-size: 0.9rem; opacity: 0.8;">
                                            ${p.indicators.buy_signals}/3 Ù„Ù„Ø´Ø±Ø§Ø¡ | ${p.indicators.sell_signals}/3 Ù„Ù„Ø¨ÙŠØ¹
                                        </div>
                                    </div>

                                    <div class="indicators-grid">
                                        <div class="indicator-box">
                                            <div>ğŸ“Š RSI</div>
                                            <div class="indicator-value" style="color: ${rsiColor}">${p.rsi}</div>
                                            <small style="color: ${rsiColor}">${p.indicators.rsi_trend}</small>
                                        </div>
                                        <div class="indicator-box">
                                            <div>ğŸ“ˆ EMA</div>
                                            <div class="indicator-value" style="color: ${emaColor}">${p.indicators.ema_trend}</div>
                                            <small>${p.ema_short.toFixed(2)}/${p.ema_long.toFixed(2)}</small>
                                        </div>
                                        <div class="indicator-box">
                                            <div>ğŸ¯ MACD</div>
                                            <div class="indicator-value" style="color: ${macdColor}">${p.indicators.macd_trend}</div>
                                            <small>${p.macd.toFixed(4)}</small>
                                        </div>
                                    </div>

                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                            <span>ğŸ“Š Ø§Ù„Ø§ØªØ¬Ø§Ù‡: ${p.trend}</span>
                                            <span>ğŸ¯ ${p.indicators.buy_signals === 3 ? 'ØªÙˆØ§ÙÙ‚ ÙƒØ§Ù…Ù„' : p.indicators.buy_signals >= 2 || p.indicators.sell_signals >= 2 ? 'ØªÙˆØ§ÙÙ‚ Ø¬Ø²Ø¦ÙŠ' : 'ØªØ¹Ø§Ø±Ø¶'}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        pricesContainer.innerHTML = pricesHTML;

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
                        const signalsContainer = document.getElementById('signals-container');
                        if (data.signals.length === 0) {
                            signalsContainer.innerHTML = `
                                <div style="text-align: center; padding: 40px;">
                                    <div style="font-size: 3em; opacity: 0.3; margin-bottom: 10px;">ğŸ”</div>
                                    <p style="opacity: 0.7; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª Ù‚ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                    <small style="opacity: 0.5;">ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆÙ‚ÙˆØ© > 70/100</small>
                                </div>
                            `;
                        } else {
                            let signalsHTML = '';
                            data.signals.forEach(signal => {
                                const signalClass = signal.action.includes('Ø¨ÙŠØ¹') ? 'signal-sell' : 'signal-buy';
                                const signalType = signal.action.includes('Ø¨ÙŠØ¹') ? 'Ø¨ÙŠØ¹' : 'Ø´Ø±Ø§Ø¡';
                                const strengthColor = signal.strength_score >= 85 ? '#ef4444' : 
                                                      signal.strength_score >= 75 ? '#f59e0b' : '#10b981';

                                signalsHTML += `
                                    <div class="signal-card ${signalClass}">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                            <div>
                                                <h3 style="margin: 0; font-size: 1.3rem;">${signal.name} - ${signal.action}</h3>
                                                <p style="margin: 5px 0 0 0; opacity: 0.8;">ğŸ’° $${signal.price.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                                            </div>
                                            <div style="background: ${strengthColor}; padding: 8px 15px; border-radius: 20px; font-weight: bold; color: white;">
                                                Ù‚ÙˆØ©: ${signal.strength_score}/100
                                            </div>
                                        </div>
                                        
                                        <div class="signal-indicators">
                                            <div class="signal-indicator" style="border-left: 3px solid ${signal.rsi < 40 ? '#10b981' : signal.rsi > 60 ? '#ef4444' : '#f59e0b'}">
                                                ğŸ“Š RSI: ${signal.rsi} (${signal.trend_rsi})
                                            </div>
                                            <div class="signal-indicator" style="border-left: 3px solid ${signal.trend_ema === 'ØµØ§Ø¹Ø¯' ? '#10b981' : signal.trend_ema === 'Ù‡Ø§Ø¨Ø·' ? '#ef4444' : '#f59e0b'}">
                                                ğŸ“ˆ EMA: ${signal.trend_ema}
                                            </div>
                                            <div class="signal-indicator" style="border-left: 3px solid ${signal.trend_macd === 'ØµØ§Ø¹Ø¯' ? '#10b981' : signal.trend_macd === 'Ù‡Ø§Ø¨Ø·' ? '#ef4444' : '#f59e0b'}">
                                                ğŸ¯ MACD: ${signal.trend_macd}
                                            </div>
                                        </div>
                                        
                                        <p style="margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; border-right: 3px solid currentColor;">
                                            ğŸ“ ${signal.reason}
                                        </p>
                                        
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                                            <div>
                                                <span>ğŸ•’ ${signal.time}</span>
                                                <span style="margin: 0 10px;">|</span>
                                                <span>ğŸ“… ${signal.date}</span>
                                            </div>
                                            <div>
                                                ${signal.buy_signals}/3 ğŸŸ¢ | ${signal.sell_signals}/3 ğŸ”´
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            signalsContainer.innerHTML = signalsHTML;
                        }

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                        document.getElementById('signals-count').textContent = data.signals_today;
                        document.getElementById('strength-avg').textContent = data.avg_strength.toFixed(1);
                        document.getElementById('last-update').textContent = data.last_update.split(' ')[1];
                        
                    })
                    .catch(error => {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                        document.getElementById('system-status').textContent = 'âŒ';
                        document.getElementById('system-status').style.color = '#ef4444';
                    });
            }

            function testTelegram() {
                fetch('/api/test-telegram')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„Ù‰ Telegram!');
                        } else {
                            alert('âš ï¸ ' + data.message);
                        }
                    });
            }

            function forceHourlyReport() {
                fetch('/api/hourly-report')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ!');
                        } else {
                            alert('âš ï¸ ' + data.message);
                        }
                    });
            }

            function refreshData() {
                fetch('/api/refresh-prices')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateDashboard();
                            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                        } else {
                            alert('âš ï¸ ' + data.message);
                        }
                    });
            }

            // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(updateDashboard, 30000);

            // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ
            updateDashboard();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
            function updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ar-EG');
                document.getElementById('last-update').textContent = timeString;
            }

            setInterval(updateCurrentTime, 1000);
            updateCurrentTime();
        </script>
    </body>
    </html>
    '''
    return render_template_string(html)

# ================== API Ø§Ù„Ù†Ù‚Ø§Ø· ==================

@app.route('/api/dashboard')
def api_advanced_dashboard():
    """Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"""
    with signal_lock:
        today = datetime.now().strftime("%Y-%m-%d")
        today_signals = [s for s in trading_signals if s.get('date') == today]

        # Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
        avg_strength = 0
        if today_signals:
            strengths = [s.get('strength_score', 0) for s in today_signals]
            avg_strength = sum(strengths) / len(strengths)

    return jsonify({
        'prices': current_prices,
        'signals': trading_signals[-5:][::-1],  # Ø¢Ø®Ø± 5 Ø¥Ø´Ø§Ø±Ø§Øª
        'signals_today': len(today_signals),
        'avg_strength': avg_strength,
        'last_update': datetime.now().strftime("%H:%M:%S"),
        'status': 'running',
        'telegram_enabled': TELEGRAM_ENABLED,
        'indicators_config': {
            'rsi_period': 14,
            'ema_short': 12,
            'ema_long': 26,
            'macd_fast': 12,
            'macd_slow': 26,
            'macd_signal': 9
        }
    })

@app.route('/api/test-telegram')
def test_telegram_advanced():
    """Ø§Ø®ØªØ¨Ø§Ø± Telegram Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª"""
    try:
        test_msg = f"""âœ… <b>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</b>

ğŸ¤– <b>Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!</b>

ğŸ“Š <b>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</b>
â€¢ ğŸ“Š RSI (14 ÙØªØ±Ø©) - Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ´Ø¨Ø¹
â€¢ ğŸ“ˆ EMA (12/26) - Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
â€¢ ğŸ¯ MACD (12,26,9) - Ù„Ù„Ø²Ø®Ù…

ğŸ¯ <b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª:</b>
â€¢ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ù†ÙŠØ§: {MIN_SIGNAL_STRENGTH}/100
â€¢ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ÙƒÙ„ {PRICE_UPDATE_INTERVAL//60} Ø¯Ù‚Ø§Ø¦Ù‚
â€¢ ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ: ÙƒÙ„ {HOURLY_REPORT_INTERVAL//3600} Ø³Ø§Ø¹Ø©

â° {datetime.now().strftime("%H:%M:%S")}
ğŸ“… {datetime.now().strftime("%Y-%m-%d")}

#Ø§Ø®ØªØ¨Ø§Ø± #Ø¨ÙˆØª_Ù…ØªÙ‚Ø¯Ù… #Ù…Ø¤Ø´Ø±Ø§Øª_ÙÙ†ÙŠØ©"""

        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        data = {
            'chat_id': TELEGRAM_CHAT_ID,
            'text': test_msg,
            'parse_mode': 'HTML'
        }
        response = requests.post(url, json=data, timeout=10)

        if response.status_code == 200:
            return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'})
        else:
            return jsonify({'success': False, 'message': f'Ø®Ø·Ø£: {response.status_code}'})

    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@app.route('/api/hourly-report')
def send_advanced_hourly_report():
    """Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹"""
    global last_hourly_report

    try:
        last_hourly_report = datetime.now() - timedelta(seconds=HOURLY_REPORT_INTERVAL)
        
        if bot.send_hourly_report():
            return jsonify({'success': True, 'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠ'})
        else:
            return jsonify({'success': False, 'message': 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'})

    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@app.route('/api/refresh-prices')
def refresh_prices():
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹"""
    try:
        success = bot.update_all_prices_with_indicators()
        if success:
            return jsonify({'success': True, 'message': 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª'})
        else:
            return jsonify({'success': False, 'message': 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)})

@app.route('/health')
def health_check_advanced():
    """ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"""
    with signal_lock:
        today = datetime.now().strftime("%Y-%m-%d")
        today_signals = [s for s in trading_signals if s.get('date') == today]

    # Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    indicator_status = {}
    for asset, data in current_prices.items():
        if data['price'] > 0:
            indicator_status[asset] = {
                'rsi': data['rsi'],
                'ema_status': data['indicators']['ema_trend'],
                'macd_status': data['indicators']['macd_trend'],
                'signal_strength': data['signal_strength']
            }

    return jsonify({
        'status': 'running',
        'timestamp': datetime.now().isoformat(),
        'signals_today': len(today_signals),
        'telegram_enabled': TELEGRAM_ENABLED,
        'indicators': {
            'rsi': 'active',
            'ema': 'active',
            'macd': 'active'
        },
        'min_signal_strength': MIN_SIGNAL_STRENGTH,
        'price_update_interval': PRICE_UPDATE_INTERVAL,
        'hourly_report_interval': HOURLY_REPORT_INTERVAL,
        'indicator_status': indicator_status
    })

# ================== Ø§Ù„ØªØ´ØºÙŠÙ„ ==================

if __name__ == "__main__":
    print("\n" + "=" * 60)
    print("ğŸ”¥ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…")
    print("=" * 60)
    print("ğŸ“Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:")
    print(f"   â€¢ ğŸ“Š RSI: {bot.rsi_period} ÙØªØ±Ø©")
    print(f"   â€¢ ğŸ“ˆ EMA: {bot.ema_short_period}/{bot.ema_long_period} ÙØªØ±Ø©")
    print(f"   â€¢ ğŸ¯ MACD: {bot.macd_fast}/{bot.macd_slow}/{bot.macd_signal_period}")
    print("âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„:")
    print(f"   â€¢ â° ØªÙ‚Ø±ÙŠØ± Ø³Ø§Ø¹ÙŠ: ÙƒÙ„ {HOURLY_REPORT_INTERVAL//3600} Ø³Ø§Ø¹Ø©")
    print(f"   â€¢ ğŸ¯ Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ù†ÙŠØ§: {MIN_SIGNAL_STRENGTH}/100")
    print(f"   â€¢ ğŸ“ˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ÙƒÙ„ {PRICE_UPDATE_INTERVAL//60} Ø¯Ù‚Ø§Ø¦Ù‚")
    print(f"   â€¢ ğŸ¤– Telegram: {'Ù…ÙØ¹Ù„' if TELEGRAM_ENABLED else 'Ù…Ø¹Ø·Ù„'}")
    print("=" * 60)

    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª ÙÙŠ thread
    bot_thread = Thread(target=bot.run, daemon=True)
    bot_thread.start()

    # ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
    port = int(os.environ.get("PORT", 5000))
    print(f"\nğŸŒ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨: http://0.0.0.0:{port}")
    print("ğŸ“± Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­")
    print("ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„...")
    print("=" * 60)

    app.run(host='0.0.0.0', port=port, debug=False, threaded=True)
